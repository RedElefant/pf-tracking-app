<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PF Circuit App</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:'Roboto', sans-serif; margin:0; padding:15px; background:#000000; color:#a855f7; scroll-behavior:smooth; }
.button-container { display:flex; justify-content:center; gap:12px; margin:20px 0; flex-wrap:wrap; }
.button-container button { background-color:#d8b4fe; color:#fff; border:none; padding:12px 22px; border-radius:14px; font-size:16px; cursor:pointer; min-width:150px; text-align:center; transition: background 0.2s, box-shadow 0.2s; box-shadow:0 4px 8px rgba(0,0,0,0.15); }
.button-container button:hover { background-color:#c084fc; box-shadow:0 6px 12px rgba(0,0,0,0.2); }
.button-container button:active { background-color:#a855f7; box-shadow:0 3px 6px rgba(0,0,0,0.25); transform:translateY(1px); }

.page { transition: opacity 0.3s ease-in-out; }
.page.hidden { display:none; opacity:0; }
.page.visible { display:block; opacity:1; }

.day-section { background:#f7f0ff; padding:15px; margin:15px auto 30px auto; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,0.08); width:95%; }
.day-title { text-align:center; font-size:1.4rem; font-weight:700; margin-bottom:10px; color:#192a56; border-bottom:2px solid #d8b4fe; padding-bottom:5px; }

table { width: 100%; border-collapse: collapse; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.08); background:#fff; table-layout: fixed; font-size:0.9rem; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
td:first-child { white-space: normal; word-break: keep-all; max-width: 165px; }
tr:last-child td { border-bottom:none; }
select,input[type="checkbox"],button.delete-btn { font-size:0.85rem; padding:4px; border-radius:6px; }

h2{text-align:center;color:#192a56;margin-bottom:15px;}
h3{margin:10px 0 5px;color:#40739e;}
#historyContent table,#summaryContent table{margin-bottom:15px;width:95%;margin-left:auto;margin-right:auto;}
.back-btn { display:block; margin:0 auto 20px auto; background-color:#d8b4fe; color:#fff; border:none; padding:10px 20px; border-radius:14px; font-size:16px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.15); transition: background 0.2s, box-shadow 0.2s; }
.back-btn:hover { background-color:#c084fc; box-shadow:0 6px 12px rgba(0,0,0,0.2); }
.back-btn:active { background-color:#a855f7; box-shadow:0 3px 6px rgba(0,0,0,0.25); transform:translateY(1px);}
.delete-btn { background-color:#f87171; color:#fff; border:none; padding:4px 8px; border-radius:8px; cursor:pointer; transition:background 0.2s; }
.delete-btn:hover { background-color:#ef4444; }
.delete-btn:active { background-color:#dc2626; transform:translateY(1px); }
@media screen and (max-width:480px){ table{ font-size:0.8rem;} th,td{padding:4px 2px;} .day-title{ font-size:1.2rem; } .button-container button{ font-size:14px; padding:8px 16px; min-width:120px; } }
</style>
</head>
<body>
<h1 style="text-align:center;">3-Day PF Circuit Plan</h1>

<div class="button-container">
  <button onclick="showPage('historyPage')">View History</button>
  <button onclick="showPage('summaryPage')">Weekly Summary</button>
</div>

<div id="mainPage" class="page visible">
  <div class="day-section"><div class="day-title">Day 1 — Full-Body (Strength) Moderate load, focus on form</div><table id="day1Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table></div>
  <div class="day-section"><div class="day-title">Day 2 — Full-Body (Volume) Slightly lighter, more reps</div><table id="day2Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table></div>
  <div class="day-section"><div class="day-title">Day 3 — Full-Body (Power) Slightly heavier, shorter sets (8 reps)</div><table id="day3Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table></div>
</div>

<div id="historyPage" class="page hidden">
  <button class="back-btn" onclick="showPage('mainPage')">Back to Main</button>
  <h2>Completed Exercises History</h2>

  <div style="text-align:center; margin-bottom:10px;">
    <label for="exerciseFilter">Filter by Exercise: </label>
    <select id="exerciseFilter"><option value="">All</option></select>
    <label style="margin-left:12px;"><input type="checkbox" id="allTimeToggle"> Show All Time</label>
  </div>

  <canvas id="progressChart" style="max-width:95%; margin:20px auto; display:block; background:#fff; border-radius:12px; padding:10px;"></canvas>

  <div id="historyContent"></div>
</div>

<div id="summaryPage" class="page hidden">
  <button class="back-btn" onclick="showPage('mainPage')">Back to Main</button>
  <h2>Weekly Summary</h2>
  <div id="summaryContent"></div>
</div>

<script>
/* === IndexedDB initialization and integration (preserve existing stores) === */
let db;
const request = indexedDB.open('WorkoutDB', 2);
request.onupgradeneeded = e => {
  db = e.target.result;
  if(!db.objectStoreNames.contains('workouts'))
    db.createObjectStore('workouts',{keyPath:'id',autoIncrement:true});
  // Add workoutHistory store if missing
  if(!db.objectStoreNames.contains('workoutHistory')){
    const store = db.createObjectStore('workoutHistory',{keyPath:'id',autoIncrement:true});
    store.createIndex('exercise','exercise',{unique:false});
    store.createIndex('date','date',{unique:false});
  }
};
request.onsuccess = async e => {
  db = e.target.result;
  await populateTables();
  renderHistory();              // original history (workouts)
  renderSummary();              // original summary
  await populateExerciseFilterUI(); // populate filter from workoutHistory
};

/* ========== EXISTING FUNCTIONALITY (unchanged) ========== */
const dayExercises = {1:['Seated Chest Press Machine','Seated Row (Cable)','Kettlebell Romanian Deadlift','Lat Pulldown','Kettlebell Shoulder Press','Leg Press Machine','Cable Oblique Pulls','Tricep Pushdown / Kettlebell Curl Superset','Back Extension Machine'],
                      2:['Seated Chest Press Machine','Seated Row (Cable)','Kettlebell Romanian Deadlift','Lat Pulldown','Kettlebell Shoulder Press','Leg Press Machine','Cable Oblique Pulls','Tricep Pushdown / Kettlebell Curl Superset','Back Extension Machine'],
                      3:['Seated Chest Press Machine','Seated Row (Cable)','Kettlebell Romanian Deadlift','Lat Pulldown','Kettlebell Shoulder Press','Leg Press Machine','Cable Oblique Pulls','Tricep Pushdown / Kettlebell Curl Superset','Back Extension Machine']};
const daySets = {1:3,2:3,3:3};
const weightOptions = Array.from({length:20},(_,i)=>15+i*5);
const repsOptions = Array.from({length:7},(_,i)=>10+i*2);

function createDropdown(options, selected){ return `<select>${options.map(o=>`<option ${o==selected?'selected':''}>${o}</option>`).join('')}</select>`; }
function getLastValue(exercise,type){ return new Promise(resolve => { const tx=db.transaction('workouts','readonly'); const store=tx.objectStore('workouts'); store.getAll().onsuccess=event=>{ const all=event.target.result.filter(e=>e.exercise===exercise); resolve(all.length?all[all.length-1][type]:null); }; }); }

async function populateTables(){
  for(let day=1;day<=3;day++){
    const table=document.getElementById(`day${day}Table`);
    for(let ex of dayExercises[day]){
      const lastReps = await getLastValue(ex,'reps');
      const lastWeight = await getLastValue(ex,'weight');
      const row=document.createElement('tr');
      const repsDropdown = createDropdown(repsOptions,lastReps||repsOptions[0]);
      const weightDropdown = createDropdown(weightOptions,lastWeight||weightOptions[0]);
      const checkbox = `<input type='checkbox' data-day='${day}'>`;
      row.innerHTML = `<td>${ex}</td><td>${daySets[day]}</td><td>${repsDropdown}</td><td>${weightDropdown}</td><td>${checkbox}</td>`;
      table.appendChild(row);
    }
  }
}

function saveExercise(day,exercise,sets,reps,weight){
  const tx=db.transaction('workouts','readwrite'); const store=tx.objectStore('workouts');
  store.add({date:new Date().toISOString().split('T')[0],day,exercise,sets,reps,weight,completed:true});
  tx.oncomplete = ()=>{ renderHistory(); renderSummary(); saveWorkoutEntry(exercise,sets,reps,weight); };
}

/* ========== NEW HISTORY TRACKING (workoutHistory store) ========== */
/* Save an entry to workoutHistory each time a workout is saved */
function saveWorkoutEntry(exercise,sets,reps,weight){
  try {
    const tx = db.transaction('workoutHistory','readwrite');
    const store = tx.objectStore('workoutHistory');
    store.add({date:new Date().toISOString().split('T')[0],exercise,sets: Number(sets) || 0, reps: Number(reps) || 0, weight: Number(weight) || 0});
  } catch (err) {
    // If store doesn't exist for some reason, ignore silently (DB upgrade should have created it)
    console.warn('saveWorkoutEntry error:', err);
  }
}

/* Helpers to query workoutHistory */
async function getWorkoutHistory(){
  return new Promise((resolve,reject)=>{
    try {
      const tx=db.transaction('workoutHistory','readonly');
      const store=tx.objectStore('workoutHistory');
      const req=store.getAll();
      req.onsuccess = e => resolve(e.target.result || []);
      req.onerror = e => reject(e);
    } catch (err) {
      resolve([]); // if store missing, return empty
    }
  });
}

async function getWorkoutHistoryByExercise(exercise){
  return new Promise((resolve,reject)=>{
    try {
      const tx=db.transaction('workoutHistory','readonly');
      const idx=tx.objectStore('workoutHistory').index('exercise');
      const req=idx.getAll(exercise);
      req.onsuccess=e=>resolve(e.target.result||[]);
      req.onerror=e=>reject(e);
    } catch (err) {
      resolve([]);
    }
  });
}

/* ========== UI: Filter dropdown and rendering filtered history ========== */
async function populateExerciseFilterUI(){
  const sel=document.getElementById('exerciseFilter'); if(!sel) return;
  const data = await getWorkoutHistory();
  const exercises = [...new Set(data.map(x=>x.exercise))].sort();
  sel.innerHTML = '<option value="">All</option>';
  exercises.forEach(ex=>{
    const opt=document.createElement('option');
    opt.value = ex;
    opt.textContent = ex;
    sel.appendChild(opt);
  });

  sel.addEventListener('change', async ()=>{
    const val = sel.value;
    const list = val ? await getWorkoutHistoryByExercise(val) : await getWorkoutHistory();
    renderFilteredHistory(list);
    // render chart for selection (if any)
    if(val) renderProgressChart(val);
    else if(chartInstance) { chartInstance.destroy(); chartInstance = null; }
  });

  // If there is a preselected value, trigger change to show data
  // (Useful when switching to history view)
}

/* Render a filtered list (grouped by date) into #historyContent */
async function renderFilteredHistory(list){
  const div=document.getElementById('historyContent');
  div.innerHTML = '';
  if(!list || list.length === 0) { div.innerHTML = '<p>No entries.</p>'; return; }
  const grouped = {};
  list.forEach(r=>{ if(!grouped[r.date]) grouped[r.date] = []; grouped[r.date].push(r); });

  Object.keys(grouped).sort((a,b)=> b.localeCompare(a)).forEach(date=>{
    const header = document.createElement('h3'); header.textContent = date; div.appendChild(header);
    const tbl = document.createElement('table');
    tbl.innerHTML = '<tr><th>Exercise</th><th>Sets×Reps</th><th>Weight</th><th>Delete</th></tr>';
    grouped[date].forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.exercise}</td><td>${e.sets}×${e.reps}</td><td>${e.weight}</td><td><button class="delete-history" data-id="${e.id}">Delete</button></td>`;
      tbl.appendChild(tr);
    });
    div.appendChild(tbl);
  });

  // wire delete buttons
  div.querySelectorAll('.delete-history').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = Number(btn.dataset.id);
      const tx = db.transaction('workoutHistory','readwrite');
      tx.objectStore('workoutHistory').delete(id);
      tx.oncomplete = async () => {
        await populateExerciseFilterUI();
        const sel = document.getElementById('exerciseFilter');
        const list = sel && sel.value ? await getWorkoutHistoryByExercise(sel.value) : await getWorkoutHistory();
        renderFilteredHistory(list);
      };
    });
  });
}

/* ========== Chart code: renders average weight per date for selected exercise ========= */
let chartInstance = null;
async function renderProgressChart(exercise){
  const canvas = document.getElementById('progressChart');
  if(!canvas) return;
  if(!exercise || exercise === '') { if(chartInstance){ chartInstance.destroy(); chartInstance=null; } return; }

  const all = await getWorkoutHistoryByExercise(exercise);
  const showAll = document.getElementById('allTimeToggle') && document.getElementById('allTimeToggle').checked;
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-7);
  const filtered = showAll ? all : all.filter(x=> new Date(x.date) >= cutoff);

  // group weights by date and compute average
  const grouped = {};
  filtered.forEach(r=>{
    grouped[r.date] = grouped[r.date] || [];
    grouped[r.date].push(Number(r.weight) || 0);
  });
  const labels = Object.keys(grouped).sort();
  const data = labels.map(d => {
    const arr = grouped[d];
    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
    return Number(avg.toFixed(1));
  });

  const ctx = canvas.getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: `${exercise} (${showAll ? 'All Time' : 'Last 7 Days'})`,
        data,
        borderColor: '#8e44ad',
        backgroundColor: 'rgba(142,68,173,0.15)',
        fill: true,
        tension: 0.3,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Weight (lbs)' } },
        x: { title: { display: true, text: 'Date' } }
      }
    }
  });
}

/* When All Time toggle changes, recompute chart for selected exercise */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'allTimeToggle'){
    const ex = document.getElementById('exerciseFilter').value;
    if(ex) renderProgressChart(ex);
  }
});

/* ========== ORIGINAL renderHistory and renderSummary kept intact ========== */
function renderHistory(){
  const div=document.getElementById('historyContent'); 
  div.innerHTML='';
  const tx=db.transaction('workouts','readonly'); 
  const store=tx.objectStore('workouts');
  store.getAll().onsuccess=event=>{
    const results=event.target.result;
    if(!results.length){ div.innerHTML='<p>No completed exercises yet.</p>'; return; }
    const grouped={}; results.forEach(r=>{ if(!grouped[r.date])grouped[r.date]=[]; grouped[r.date].push(r); });
    
    for(const date in grouped){
      const dayGroup=grouped[date];
      const header=document.createElement('h3'); header.textContent=date; div.appendChild(header);

      const tbl=document.createElement('table'); 
      tbl.innerHTML='<tr><th>Day</th><th>Exercise</th><th>Sets × Reps</th><th>Weight</th><th>Delete</th></tr>';

      dayGroup.forEach(e=>{
        const row=document.createElement('tr');
        row.innerHTML=`
          <td>${e.day}</td>
          <td>${e.exercise}</td>
          <td>${e.sets} × ${e.reps}</td>
          <td>${e.weight}</td>
          <td><button class="delete-btn" data-id="${e.id}">Delete</button></td>
        `;
        tbl.appendChild(row);
      });
      div.appendChild(tbl);
    }

    div.querySelectorAll('.delete-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = parseInt(btn.dataset.id);
        const tx=db.transaction('workouts','readwrite'); 
        const store=tx.objectStore('workouts'); 
        store.delete(id);
        tx.oncomplete = ()=>{ renderHistory(); renderSummary(); };
      });
    });
  };
}

function renderSummary(){
  const div=document.getElementById('summaryContent'); div.innerHTML='';
  const tx=db.transaction('workouts','readonly'); const store=tx.objectStore('workouts');
  store.getAll().onsuccess=event=>{
    const results=event.target.result;
    if(!results.length){ div.innerHTML='<p>No exercises yet.</p>'; return; }
    const dayTotals={1:0,2:0,3:0};
    results.forEach(r=>{ if(r.completed) dayTotals[r.day]+=(r.sets*r.reps); });
    const tbl=document.createElement('table'); tbl.innerHTML='<tr><th>Day</th><th>Total Completed Reps</th></tr>';
    for(const day in dayTotals) tbl.innerHTML+=`<tr><td>${day}</td><td>${dayTotals[day]}</td></tr>`;
    div.appendChild(tbl);
  };
}

/* ========== Wire checkbox "Done" behavior to saveExercise (and history) ========== */
document.body.addEventListener('change', e=>{
  if(e.target && e.target.type==='checkbox' && e.target.dataset.day){
    const row=e.target.closest('tr');
    if(e.target.checked){
      const exercise=row.cells[0].textContent;
      const sets=parseInt(row.cells[1].textContent);
      const reps=parseInt(row.cells[2].querySelector('select').value);
      const weight=parseInt(row.cells[3].querySelector('select').value);
      const day=parseInt(e.target.dataset.day);
      saveExercise(day,exercise,sets,reps,weight);
    }
  }
});

/* ========== showPage: ensure history UI and chart get populated when shown ========== */
async function showPage(pageId){
  ['mainPage','historyPage','summaryPage'].forEach(id=>document.getElementById(id).className='page hidden');
  document.getElementById(pageId).className='page visible';

  // Additional actions when showing history or summary
  if(pageId === 'historyPage'){
    // Populate filter (in case new entries were added) and render default (all)
    await populateExerciseFilterUI();
    const sel = document.getElementById('exerciseFilter');
    const list = sel && sel.value ? await getWorkoutHistoryByExercise(sel.value) : await getWorkoutHistory();
    renderFilteredHistory(list);
    // If a selection exists, render its chart
    if(sel && sel.value) renderProgressChart(sel.value);
  } else if(pageId === 'summaryPage'){
    renderSummary();
  }
}

/* ========== Initial population on DOMContentLoaded already handled by request.onsuccess above ========== */
/* In case code loads before DB ready, we'll also guard-call populateExerciseFilterUI when needed */
</script>
</body>
</html>
