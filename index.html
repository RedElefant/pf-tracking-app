<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PF Circuit App PWA</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#d7bde2">
<style>
  body { font-family: 'Roboto', sans-serif; margin: 10px; background: #f5f6fa; color: #2f3640; }
  h1 { text-align: center; color: #192a56; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
  th { background-color: #d7bde2; color: #2f3640; }
  tr:nth-child(even) { background-color: #dcdde1; }
  select, input[type="checkbox"] { font-size: 1rem; padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
  .day-title { font-size: 1.4rem; margin: 20px 0 10px; font-weight: 700; color: #192a56; text-align: center; }
  #historyView, #weeklySummaryView { display: none; margin-top: 20px; }
  .toggle-btn { padding: 10px 20px; font-size: 1rem; margin-bottom: 15px; cursor: pointer; background: #d7bde2; color: #2f3640; border: none; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  .toggle-btn:hover { background: #c39bd3; }
  h2 { color: #192a56; text-align: center; }
  h3 { margin: 10px 0 5px; color: #40739e; }
  #historyContent table, #weeklySummaryContent table { margin-bottom: 15px; }
</style>
</head>
<body>
<h1>3-Day PF Circuit Plan</h1>
<button class="toggle-btn" id="toggleView">View History</button>
<button class="toggle-btn" id="toggleWeekly">View Weekly Summary</button>
<div id="workoutView">
  <div class="day-title">Day 1 — Chest & Back Focus</div>
  <table id="day1Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table>

  <div class="day-title">Day 2 — Lower Body Focus</div>
  <table id="day2Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table>

  <div class="day-title">Day 3 — Shoulders & Arms Focus</div>
  <table id="day3Table"><tr><th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>Done</th></tr></table>
</div>

<div id="historyView">
  <h2>Completed Exercises History</h2>
  <div id="historyContent"></div>
</div>

<div id="weeklySummaryView">
  <h2>Weekly Summary</h2>
  <div id="weeklySummaryContent"></div>
</div>

<script>
// IndexedDB Setup
let db;
const request = indexedDB.open('WorkoutDB', 1);
request.onupgradeneeded = function(e) { db = e.target.result; db.createObjectStore('workouts', { keyPath: 'id', autoIncrement: true }); };
request.onsuccess = async function(e) { db = e.target.result; await populateTables(); renderHistory(); };

// Options
const weightOptions = Array.from({length: 11}, (_, i) => 20 + i*10);
const repsOptions = Array.from({length: 7}, (_, i) => 8 + i*2);
const dayExercises = { 1: ['Chest Press Machine','Back Extension Machine','Lat Pulldown Machine','Seated Row Machine','Abdominal Crunch Machine','Torso Rotation Machine (per side)','Pec Deck (Butterfly) Machine'], 2: ['Leg Press Machine','Seated Leg Curl Machine','Leg Extension Machine','Calf Extension Machine','Abdominal Crunch Machine','Hip Abduction Machine','Hip Adduction Machine','Lunge Machine'], 3: ['Shoulder Press Machine','Torso Rotation Machine (per side)','Abdominal Crunch Machine','Bicep Curl Machine','Tricep Extension Machine','Seated Dip Machine','Rear Delt Fly (Reverse Pec Deck)','Dumbbell Lateral Raise'] };
const daySets = {1:3,2:3,3:3};

function createDropdown(options, selected) { return `<select>${options.map(o => `<option ${o==selected?'selected':''}>${o}</option>`).join('')}</select>`; }

function saveExercise(day, exercise, sets, reps, weight) {
  const tx = db.transaction('workouts', 'readwrite');
  const store = tx.objectStore('workouts');
  store.add({ date: new Date().toISOString().split('T')[0], day, exercise, sets, reps, weight, completed: true });
  tx.oncomplete = () => { renderHistory(); renderWeeklySummary(); };
}

function getLastValueAsync(exercise, type) {
  return new Promise(resolve => {
    const tx = db.transaction('workouts','readonly');
    const store = tx.objectStore('workouts');
    store.getAll().onsuccess = function(event) {
      const all = event.target.result.filter(e => e.exercise === exercise);
      if(all.length === 0) resolve(null);
      else resolve(all[all.length-1][type]);
    };
  });
}

async function populateTables() {
  for (let day = 1; day <= 3; day++) {
    const table = document.getElementById(`day${day}Table`);
    for (const ex of dayExercises[day]) {
      const lastReps = await getLastValueAsync(ex, 'reps') || repsOptions[0];
      const lastWeight = await getLastValueAsync(ex, 'weight') || weightOptions[0];
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ex}</td>
        <td>${daySets[day]}</td>
        <td>${createDropdown(repsOptions, lastReps)}</td>
        <td>${createDropdown(weightOptions, lastWeight)}</td>
        <td><input type='checkbox' data-day='${day}'></td>
      `;
      table.appendChild(row);
    }
  }
}

function renderHistory() {
  const historyDiv = document.getElementById('historyContent');
  historyDiv.innerHTML = '';
  const tx = db.transaction('workouts', 'readonly');
  const store = tx.objectStore('workouts');
  store.getAll().onsuccess = function(event) {
    const results = event.target.result;
    if(results.length === 0) { historyDiv.innerHTML = '<p>No completed exercises yet.</p>'; return; }
    const grouped = {};
    results.forEach(r => { if(!grouped[r.date]) grouped[r.date] = []; grouped[r.date].push(r); });
    for(const date in grouped) {
      const dayGroup = grouped[date];
      const dateHeader = document.createElement('h3'); dateHeader.textContent = date; historyDiv.appendChild(dateHeader);
      const tbl = document.createElement('table');
      tbl.innerHTML = '<tr><th>Day</th><th>Exercise</th><th>Sets × Reps</th><th>Weight</th></tr>';
      dayGroup.forEach(e => { const row = document.createElement('tr'); row.innerHTML = `<td>${e.day}</td><td>${e.exercise}</td><td>${e.sets} × ${e.reps}</td><td>${e.weight}</td>`; tbl.appendChild(row); });
      historyDiv.appendChild(tbl);
    }
  };
}

function renderWeeklySummary() {
  const summaryDiv = document.getElementById('weeklySummaryContent');
  summaryDiv.innerHTML = '';
  const tx = db.transaction('workouts','readonly');
  const store = tx.objectStore('workouts');
  store.getAll().onsuccess = function(event){
    const results = event.target.result;
    if(results.length === 0){ summaryDiv.innerHTML = '<p>No data yet.</p>'; return; }
    const weekGrouped = {};
    results.forEach(r => {
      const week = new Date(r.date).getWeekNumber();
      const key = week + '_' + r.exercise;
      if(!weekGrouped[key]) weekGrouped[key] = {sets:0, repsTotal:0, weightTotal:0, count:0, exercise:r.exercise, week:week};
      weekGrouped[key].sets += r.sets;
      weekGrouped[key].repsTotal += r.reps;
      weekGrouped[key].weightTotal += r.weight;
      weekGrouped[key].count += 1;
    });
    const tbl = document.createElement('table');
    tbl.innerHTML = '<tr><th>Week</th><th>Exercise</th><th>Total Sets</th><th>Avg Reps</th><th>Avg Weight</th></tr>';
    Object.values(weekGrouped).forEach(w => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${w.week}</td><td>${w.exercise}</td><td>${w.sets}</td><td>${Math.round(w.repsTotal/w.count)}</td><td>${Math.round(w.weightTotal/w.count)}</td>`;
      tbl.appendChild(row);
    });
    summaryDiv.appendChild(tbl);
  };
}

Date.prototype.getWeekNumber = function() {
  const d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
};

// Toggle views
document.getElementById('toggleView').addEventListener('click', function() {
  document.getElementById('workoutView').style.display = 'none';
  document.getElementById('weeklySummaryView').style.display = 'none';
  document.getElementById('historyView').style.display = 'block';
  this.textContent = 'Back to Workout';
});

document.getElementById('toggleWeekly').addEventListener('click', function() {
  document.getElementById('workoutView').style.display = 'none';
  document.getElementById('historyView').style.display = 'none';
  document.getElementById('weeklySummaryView').style.display = 'block';
  this.textContent = 'Back to Workout';
});

// Unified change listener
document.body.addEventListener('change', function(e) {
  const row = e.target.closest('tr');
  if (!row) return;
  const exercise = row.cells[0].textContent;
  const sets = parseInt(row.cells[1].textContent);
  const reps = parseInt(row.cells[2].querySelector('select').value);
  const weight = parseInt(row.cells[3].querySelector('select').value);
  const day = parseInt(row.querySelector('input[type="checkbox"]').dataset.day);
  if(e.target.tagName === 'SELECT' || (e.target.type === 'checkbox' && e.target.dataset.day)) saveExercise(day, exercise, sets, reps, weight);
});

// Register Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(reg => console.log('Service Worker registered.', reg)).catch(err => console.log('SW failed:', err));
}
</script>
</body>
</html>
